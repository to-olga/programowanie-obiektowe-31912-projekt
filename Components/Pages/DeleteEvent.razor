@page "/Event/{id:int}/Delete"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using PetHealthHistory.Data

<PageTitle>Delete Event</PageTitle>

<h3>Delete Event</h3>

@if (_event == null)
{
    <p>Loading...</p>
}
else
{
    <div class="alert alert-danger">
        <h4>Are you sure you want to delete this event?</h4>
        <p><strong>Type:</strong> @_event.EventType.GetLabel()</p>
        <p><strong>Date:</strong> @_event.Date.ToShortDateString()</p>
        <p>This action cannot be undone.</p>
        
        <div class="mt-3">
            <button class="btn btn-secondary" @onclick='() => NavigationManager.NavigateTo($"/Pet/{_event.PetId}")'>Cancel</button>
            <button class="btn btn-danger" @onclick="Delete">Confirm Delete</button>
        </div>
    </div>
}

@code 
{
    [Parameter] public int Id { get; set; }

    [Inject] private IDbContextFactory<PetHealthHistoryContext> DbFactory { get; set; }
    [Inject] private NavigationManager NavigationManager { get; set; }

    private Event? _event;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await using var context = DbFactory.CreateDbContext();
            _event = await context.Events.FindAsync(Id);

            if (_event == null)
            {
                NavigationManager.NotFound();
                return;
            }
            
            StateHasChanged();
        }
    }

    private async Task Delete()
    {
        if (_event != null)
        {
            await using var context = DbFactory.CreateDbContext();
            context.Events.Remove(_event);
            await context.SaveChangesAsync();
            NavigationManager.NavigateTo($"/Pet/{_event.PetId}");
        }
    }
}