@using Microsoft.EntityFrameworkCore
@using PetHealthHistory.Data

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="text-danger mb-3">@_error</div>
}

<div class="row py-2">
    <div class="col-2 col-form-label">
        <label for="EventType">Event Type:</label>
    </div>
    <div class="col-6">
        <InputRadioGroup id="EventType" @bind-Value="EventType" @bind-Value:after="ResetError">
            @foreach (var type in Enum.GetValues<EventType>())
            {
                <InputRadio id="@($"EventType-{type}")" Value="type" />
                <label for="@($"EventType-{type}")">&nbsp;@type.GetLabel()</label>
                <br/>
            }
        </InputRadioGroup>
    </div>
</div>

<div class="row py-2">
    <div class="col-2 col-form-label">
        <label for="Date">Date:</label>
    </div>
    <div class="col-6">
        <input id="Date" type="date" class="form-control" @bind="Date" max="@DateTime.Today.ToString("yyyy-MM-dd")" required />
    </div>
</div>

@if (EventType is EventType.Visit or EventType.Procedure)
{
    <div class="row py-2">
        <div class="col-2 col-form-label">
            <label for="Doctor">Doctor:</label>
        </div>
        <div class="col-6">
            <input id="Doctor" type="text" class="form-control" @bind="Doctor" list="doctorSuggestions" required />
        </div>
    </div>
    <div class="row py-2">
        <div class="col-2 col-form-label">
            <label for="Clinic">Clinic:</label>
        </div>
        <div class="col-6">
            <input id="Clinic" type="text" class="form-control" @bind="Clinic" list="clinicSuggestions" required />
        </div>
    </div>
    @if (EventType == EventType.Procedure)
    {
        <div class="row py-2">
            <div class="col-2 col-form-label">
                <label for="ProcedureName">Procedure Name:</label>
            </div>
            <div class="col-6">
                <input id="ProcedureName" type="text" class="form-control" @bind="ProcedureName" required />
            </div>
        </div>
    }
    <div class="row py-2">
        <div class="col-2 col-form-label">
            <label for="Description">Description:</label>
        </div>
        <div class="col-6">
            <textarea id="Description" class="form-control" @bind="Description"></textarea>
        </div>
    </div>
    
    <datalist id="doctorSuggestions">
        @foreach (var suggestion in _doctorSuggestions)
        {
            <option value="@suggestion"></option>
        }
    </datalist>
    <datalist id="clinicSuggestions">
        @foreach (var suggestion in _clinicSuggestions)
        {
            <option value="@suggestion"></option>
        }
    </datalist>
}
else if (EventType == EventType.LabTest)
{
    <div class="row py-2">
        <div class="col-2 col-form-label">
            <label for="LabName">Laboratory:</label>
        </div>
        <div class="col-6">
            <input id="LabName" type="text" class="form-control" @bind="LabName" list="labNameSuggestions" required />
        </div>
    </div>
    <div class="row py-2">
        <div class="col-2 col-form-label">
            <label for="OrderedBy">Ordered By:</label>
        </div>
        <div class="col-6">
            <input id="OrderedBy" type="text" class="form-control" @bind="OrderedBy" list="orderedBySuggestions" />
        </div>
    </div>

    <div class="mt-3">
        <h5>Test Results</h5>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Test Name</th>
                    <th>Value</th>
                    <th>Normal Range</th>
                    <th>In Range?</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var result in LabResults)
                {
                    <tr>
                        <td><input type="text" class="form-control form-control-sm" @bind="result.TestName" list="testNameSuggestions" required /></td>
                        <td><input type="text" class="form-control form-control-sm" @bind="result.Value" required /></td>
                        <td><input type="text" class="form-control form-control-sm" @bind="result.NormalRange" /></td>
                        <td><input type="checkbox" @bind="result.InNormalRange" /></td>
                        <td>
                            <button class="btn btn-outline-danger btn-sm" @onclick="() => LabResults.Remove(result)">Remove</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <datalist id="testNameSuggestions">
            @foreach (var suggestion in _testNameSuggestions)
            {
                <option value="@suggestion"></option>
            }
        </datalist>
        <button class="btn btn-outline-secondary btn-sm" @onclick="AddLabResult">+ Add Result</button>
    </div>
    <datalist id="labNameSuggestions">
        @foreach (var suggestion in _labNameSuggestions)
        {
            <option value="@suggestion"></option>
        }
    </datalist>
    <datalist id="orderedBySuggestions">
        @foreach (var suggestion in _orderedBySuggestions)
        {
            <option value="@suggestion"></option>
        }
    </datalist>
}

<div class="d-flex gap-2 mt-4">
    <button class="btn btn-outline-secondary" @onclick='() => NavigationManager.NavigateTo($"/Pet/{PetId}")'>Cancel</button>
    <button class="btn btn-primary" @onclick="Save">@SaveLabel</button>
</div>

@code 
{
    [Parameter] public int? Id { get; set; }
    [Parameter] public int PetId { get; set; }
    [Parameter] public EventType EventType { get; set; } = EventType.Visit;
    [Parameter] public DateOnly Date { get; set; } = DateOnly.FromDateTime(DateTime.Today);
    
    [Parameter] public string? Doctor { get; set; }
    [Parameter] public string? Clinic { get; set; }
    [Parameter] public string? Description { get; set; }
    
    [Parameter] public string? ProcedureName { get; set; }
    
    [Parameter] public string? LabName { get; set; }
    [Parameter] public string? OrderedBy { get; set; }
    [Parameter] public List<LabResultModel> LabResults { get; set; } = new();

    [Parameter] public string SaveLabel { get; set; } = "Add";

    [Inject] private IDbContextFactory<PetHealthHistoryContext> DbFactory { get; set; }
    [Inject] private NavigationManager NavigationManager { get; set; }

    private string? _error;
    private List<string> _doctorSuggestions = new();
    private List<string> _clinicSuggestions = new();
    private List<string> _testNameSuggestions = new();
    private List<string> _labNameSuggestions = new();
    private List<string> _orderedBySuggestions = new();
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await using var context = DbFactory.CreateDbContext();
            
            // pobierz z bazy danych listy istniejących wartości do podpowiedzi pól
            _doctorSuggestions = await context.Events.OfType<Visit>()
                .Select(v => v.Doctor)
                .Distinct()
                .OrderBy(d => d)
                .ToListAsync();

            _clinicSuggestions = await context.Events.OfType<Visit>()
                .Select(v => v.Clinic)
                .Distinct()
                .OrderBy(c => c)
                .ToListAsync();

            _testNameSuggestions = await context.LabTestResults
                .Select(r => r.TestName)
                .Distinct()
                .OrderBy(t => t)
                .ToListAsync();

            _labNameSuggestions = await context.Events.OfType<LabTest>()
                .Select(l => l.LabName)
                .Distinct()
                .OrderBy(l => l)
                .ToListAsync();
            
            var orderedBySuggestions = await context.Events.OfType<LabTest>()
                .Select(l => l.OrderedBy ?? string.Empty)
                .Where(o => !string.IsNullOrWhiteSpace(o))
                .ToListAsync();
            
            // podpowiedzi pola 'Ordered by' poza poprzednini wartościam itego pola zawierają także lekarzy i kliniki
            orderedBySuggestions.AddRange(_doctorSuggestions);
            orderedBySuggestions.AddRange(_clinicSuggestions);
            _orderedBySuggestions = orderedBySuggestions.Distinct().Order().ToList();
            
            StateHasChanged();
        }
    }

    private void AddLabResult()
    {
        LabResults.Add(new LabResultModel());
    }

    private async Task Save()
    {
        _error = null;
        
        // walidacja pól wymaganych na podstawie typu zdarzenia
        var missingData = new List<string>();
        if (EventType is EventType.Visit or EventType.Procedure)
        {
            if (string.IsNullOrWhiteSpace(Doctor))
            {
                missingData.Add("Doctor");
            }
            if (string.IsNullOrWhiteSpace(Clinic))
            {
                missingData.Add("Clinic");
            }
            if (string.IsNullOrWhiteSpace(Description))
            {
                missingData.Add("Description");
            }
            if (EventType == EventType.Procedure && string.IsNullOrWhiteSpace(ProcedureName))
            {
                missingData.Add("Procedure Name");
            }
        }
        else if (EventType == EventType.LabTest)
        {
            if (string.IsNullOrWhiteSpace(LabName))
            {
                missingData.Add("Laboratory");
            }

            if (LabResults.Any(lr => string.IsNullOrWhiteSpace(lr.TestName)))
            {
                missingData.Add("Test Name");
            }

            if (LabResults.Any(lr => string.IsNullOrWhiteSpace(lr.Value)))
            {
                missingData.Add("Test Result Value");
            }
        }
        
        // wyświetł błąd jeżeli jakiekolwiek pole było nieprawidłowe
        if (missingData.Count > 0)
        {
            _error = $"Please fill in the following required fields: {string.Join(", ", missingData)}";
            return;
        }

        try
        {
            await using var context = DbFactory.CreateDbContext();
            
            // jeżeli parametr Id ma wartość to jest to edycja a nie dodanie nowego zdarzenia
            if (Id.HasValue)
            {
                var ev = await context.Events.FindAsync(Id.Value);
                if (ev == null)
                {
                    NavigationManager.NotFound();
                    return;
                }

                if (ev.EventType != EventType)
                {
                    // przy zmianie typu tworzymy obiekt na nowo, a stary usuwamy
                    var newEvent = CreateEvent();
                    context.Events.Remove(ev);
                    context.Events.Add(newEvent);
                }
                else
                {
                    ev.Date = Date;

                    if (ev is Visit v)
                    {
                        v.Doctor = Doctor!;
                        v.Clinic = Clinic!;
                        v.Description = Description!;
                        if (v is Procedure p)
                        {
                            p.Name = ProcedureName!;
                        }
                    }
                    else if (ev is LabTest lt)
                    {
                        lt.LabName = LabName!;
                        lt.OrderedBy = OrderedBy;

                        lt.Results.Clear();
                        foreach (var r in LabResults)
                        {
                            lt.Results.Add(new LabTestResult(r.TestName, r.Value, r.NormalRange, r.InNormalRange, lt.Id));
                        }
                    }
                }
            }
            else
            {
                var ev = CreateEvent();
                context.Events.Add(ev);
            }

            await context.SaveChangesAsync();
            NavigationManager.NavigateTo($"/Pet/{PetId}");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private Event CreateEvent()
    {
        return EventType switch
        {
            EventType.Visit => new Visit(Date, PetId, Doctor!, Clinic!, Description!),
            EventType.Procedure => new Procedure(Date, PetId, Doctor!, Clinic!, Description!, ProcedureName!),
            EventType.LabTest => new LabTest(Date, PetId, LabName!, OrderedBy,
                LabResults.Select(r => new LabTestResult(r.TestName, r.Value, r.NormalRange, r.InNormalRange)).ToList()),
            _ => throw new ArgumentOutOfRangeException()
        };
    }
    
    private void ResetError()
    {
        _error = null;
	}

    public class LabResultModel
    {
        public string TestName { get; set; } = "";
        public string Value { get; set; } = "";
        public string? NormalRange { get; set; }
        public bool InNormalRange { get; set; } = true;
    }
}
